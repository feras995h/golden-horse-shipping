#!/usr/bin/env node

/**
 * Ø³ÙƒØ±ÙŠØ¨Øª Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø§Ø±ÙŠ Ù„Ù„Ø§Ø³ØªØ¶Ø§ÙØ©
 * Admin User Creation Script for Hosting
 */

const { Client } = require('pg');
const bcrypt = require('bcrypt');

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
// Database configuration from environment variables
const dbConfig = {
  host: process.env.DATABASE_HOST || 'localhost',
  port: process.env.DATABASE_PORT || 5432,
  database: process.env.DATABASE_NAME || 'golden_horse_db',
  user: process.env.DATABASE_USER || 'postgres',
  password: process.env.DATABASE_PASSWORD || 'postgres',
};

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
// Admin user data
const adminData = {
  username: 'admin',
  email: 'admin@goldenhorse-shipping.com',
  password: 'admin123',
  role: 'ADMIN'
};

async function createAdminUser() {
  const client = new Client(dbConfig);
  
  try {
    console.log('ğŸ”— Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    console.log('ğŸ”— Connecting to database...');
    
    await client.connect();
    
    console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
    console.log('âœ… Connected successfully');
    
    // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // Check if user exists
    console.log('ğŸ” ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ...');
    console.log('ğŸ” Checking if admin user exists...');
    
    const existingUser = await client.query(
      'SELECT * FROM users WHERE username = $1 OR email = $2',
      [adminData.username, adminData.email]
    );
    
    if (existingUser.rows.length > 0) {
      console.log('âš ï¸  Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
      console.log('âš ï¸  Admin user already exists');
      
      // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      // Update password
      console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...');
      console.log('ğŸ”„ Updating password...');
      
      const hashedPassword = await bcrypt.hash(adminData.password, 10);
      
      await client.query(
        'UPDATE users SET password = $1, updated_at = NOW() WHERE username = $2',
        [hashedPassword, adminData.username]
      );
      
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
      console.log('âœ… Password updated successfully');
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
      // Create new user
      console.log('ğŸ‘¤ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø§Ø±ÙŠ Ø¬Ø¯ÙŠØ¯...');
      console.log('ğŸ‘¤ Creating new admin user...');
      
      const hashedPassword = await bcrypt.hash(adminData.password, 10);
      const userId = require('crypto').randomUUID();
      
      await client.query(`
        INSERT INTO users (id, username, email, password, role, created_at, updated_at)
        VALUES ($1, $2, $3, $4, $5, NOW(), NOW())
      `, [userId, adminData.username, adminData.email, hashedPassword, adminData.role]);
      
      console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
      console.log('âœ… Admin user created successfully');
    }
    
    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    // Display login credentials
    console.log('\nğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:');
    console.log('ğŸ“‹ Login Credentials:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(`ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Username: ${adminData.username}`);
    console.log(`ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± / Password: ${adminData.password}`);
    console.log(`ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / Email: ${adminData.email}`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    // Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    // Test login
    console.log('\nğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
    console.log('ğŸ§ª Testing login...');
    
    const testUser = await client.query(
      'SELECT id, username, email, role FROM users WHERE username = $1',
      [adminData.username]
    );
    
    if (testUser.rows.length > 0) {
      const user = testUser.rows[0];
      console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
      console.log('âœ… User found:');
      console.log(`   ID: ${user.id}`);
      console.log(`   Username: ${user.username}`);
      console.log(`   Email: ${user.email}`);
      console.log(`   Role: ${user.role}`);
    }
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ:');
    console.error('âŒ Error creating admin user:');
    console.error(error.message);
    
    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ´Ø®ÙŠØµ
    // Additional diagnostic information
    console.log('\nğŸ” Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ:');
    console.log('ğŸ” Diagnostic Information:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('Database Config:');
    console.log(`  Host: ${dbConfig.host}`);
    console.log(`  Port: ${dbConfig.port}`);
    console.log(`  Database: ${dbConfig.database}`);
    console.log(`  User: ${dbConfig.user}`);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    process.exit(1);
  } finally {
    await client.end();
    console.log('\nğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    console.log('ğŸ”Œ Database connection closed');
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
// Run script
if (require.main === module) {
  console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ù„Ù„Ø§Ø³ØªØ¶Ø§ÙØ©...');
  console.log('ğŸš€ Starting admin user creation for hosting...');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  createAdminUser()
    .then(() => {
      console.log('\nğŸ‰ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
      console.log('ğŸ‰ Process completed successfully!');
      process.exit(0);
    })
    .catch((error) => {
      console.error('\nğŸ’¥ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:');
      console.error('ğŸ’¥ Process failed:');
      console.error(error);
      process.exit(1);
    });
}

module.exports = { createAdminUser };